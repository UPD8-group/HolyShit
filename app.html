<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HolyShit.app â€” Relief Radar</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon-48.png">
    <link rel="shortcut icon" href="favicon.png">
    <meta name="theme-color" content="#0D1628">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HolyShit">
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,700;0,800;0,900;1,800;1,900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
    /* â”€â”€ Tokens â”€â”€ */
    :root {
        --navy:      #0D1628;
        --navy-card: #1A2740;
        --navy-line: #243350;
        --orange:    #FC4C02;
        --orange-dk: #D93D00;
        --white:      #FFFFFF;
        --grey:      #8A9BB5;
        --grey-lt:   #C4CFDF;
        --cyan:      #06B6D4;
        --green:     #22C55E;
        --green-dk:  #16A34A;
        --blue:      #4285F4;
        --nav-h:     calc(64px + env(safe-area-inset-bottom, 0px));
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--navy); overflow: hidden; color: var(--white); }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        MAP
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #map { position: fixed; inset: 0; height: 100vh; width: 100vw; }

    /* Map UI Controls Overrides */
    .gm-bundled-control, .gm-fullscreen-control, .gm-svpc { bottom: calc(var(--nav-h) + 12px) !important; }
    .gm-style-mtc-bbw, .gm-style .gm-style-mtc { top: calc(env(safe-area-inset-top, 0px) + 12px) !important; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        BOTTOM NAV BAR
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #bottom-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-h); z-index: 2500;
        background: rgba(26, 39, 64, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-top: 1px solid var(--navy-line); display: flex; align-items: flex-start;
        padding-top: 8px; padding-bottom: env(safe-area-inset-bottom, 0px);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    }
    .nav-tab {
        flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        gap: 4px; cursor: pointer; padding: 6px 4px 0; border: none; background: transparent;
        appearance: none; -webkit-tap-highlight-color: transparent; position: relative;
    }
    .nav-icon { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; border-radius: 8px; transition: background 0.15s, transform 0.15s; }
    .nav-label { font-size: 0.6rem; font-weight: 600; letter-spacing: 0.3px; color: var(--grey); transition: color 0.15s; white-space: nowrap; }
    .nav-tab.active .nav-icon { background: rgba(252,76,2,0.15); }
    .nav-tab.active .nav-label { color: var(--orange); }
    .nav-tab.running .nav-icon { background: rgba(34,197,94,0.15); animation: pulse-green 1.5s ease-in-out infinite; }
    .nav-tab.running .nav-label { color: var(--green); }

    @keyframes pulse-green {
        0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
        50% { box-shadow: 0 0 0 8px rgba(34,197,94,0); }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        RUN HUD & PLANNER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #run-hud {
        position: fixed; top: 0; left: 0; right: 0; z-index: 1500; display: flex;
        transform: translateY(-100%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #run-hud.active { transform: translateY(0); }
    .hud-cell { flex: 1; background: rgba(13,22,40,0.96); backdrop-filter: blur(16px); border-bottom: 3px solid var(--orange); padding: calc(env(safe-area-inset-top, 0px) + 14px) 0 14px; text-align: center; }
    .hud-cell + .hud-cell { border-left: 1px solid var(--navy-line); }
    .hud-value { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; font-size: 1.9rem; line-height: 1; color: var(--white); }
    .hud-value.hl { color: var(--orange); }
    .hud-label { font-size: 0.55rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--grey); margin-top: 4px; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        SHEETS & CARDS
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #sheet, #route-summary, #more-sheet {
        position: fixed; bottom: calc(var(--nav-h) - 4px); left: 0; right: 0;
        background: var(--navy-card); border-top: 3px solid var(--orange); border-radius: 16px 16px 0 0;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 2000;
        padding: 8px 20px 24px; transform: translateY(101%); box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
    }
    #sheet.open, #route-summary.open, #more-sheet.open { transform: translateY(0); }
    #route-summary { border-top-color: var(--green); }
    #more-sheet { bottom: var(--nav-h); padding: 8px 0 calc(env(safe-area-inset-bottom, 16px) + 20px); }

    .facility-name { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; font-size: 1.8rem; margin: 0 0 6px; }
    .tag { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 6px; font-size: 0.75rem; border: 1px solid var(--navy-line); color: var(--grey-lt); }

    /* Action Buttons */
    .btn-action { padding: 14px; border-radius: 10px; border: none; font-family: 'Barlow Condensed', sans-serif; font-weight: 800; font-style: italic; cursor: pointer; transition: transform 0.1s; text-align: center; }
    .btn-primary { background: var(--orange); color: white; box-shadow: 0 4px 0 var(--orange-dk); width: 100%; margin-top: 10px; }
    .btn-secondary { background: var(--navy); border: 1px solid var(--navy-line); color: var(--white); width: 100%; margin-top: 10px; }
    .btn-go { background: var(--orange); color: white; width: 100%; padding: 16px; border-radius: 12px; font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; font-size: 1.2rem; border: none; cursor: pointer; box-shadow: 0 4px 0 var(--orange-dk); }

    /* Summary Modal */
    .stat-card { background: var(--navy); border: 1px solid var(--navy-line); border-radius: 12px; padding: 15px; text-align: center; }
    .stat-value { font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; font-size: 1.8rem; }

    /* Overlay */
    #overlay { position: fixed; inset: 0; z-index: 1800; background: rgba(0,0,0,0.6); opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    #overlay.show { opacity: 1; pointer-events: auto; }

    /* SV Modal */
    #sv-modal { position: fixed; inset: 0; z-index: 9000; background: #000; display: none; flex-direction: column; }
    #sv-modal.open { display: flex; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="run-hud">
    <div class="hud-cell"><div class="hud-value" id="hud-dist">0.00</div><div class="hud-label" id="hud-dist-lbl">KM</div></div>
    <div class="hud-cell"><div class="hud-value hl" id="hud-pace">--:--</div><div class="hud-label" id="hud-pace-lbl">MIN/KM</div></div>
    <div class="hud-cell"><div class="hud-value" id="hud-pits">0</div><div class="hud-label">PIT STOPS</div></div>
</div>

<nav id="bottom-nav">
    <button class="nav-tab" id="tab-near" onclick="navTap('near')">
        <div class="nav-icon">ğŸ’©</div><div class="nav-label">Near Me</div>
    </button>
    <button class="nav-tab" id="tab-plan" onclick="navTap('plan')">
        <div class="nav-icon">ğŸ—ºï¸</div><div class="nav-label">Plan</div>
    </button>
    <button class="nav-tab active" id="tab-home" onclick="navTap('home')">
        <div class="nav-icon">ğŸ </div><div class="nav-label">Home</div>
    </button>
    <button class="nav-tab" id="tab-run" onclick="navTap('run')">
        <div class="nav-icon">â–¶ï¸</div><div class="nav-label">Run</div>
    </button>
    <button class="nav-tab" id="tab-more" onclick="navTap('more')">
        <div class="nav-icon">â˜°</div><div class="nav-label">More</div>
    </button>
</nav>

<div id="sheet">
    <div style="color:var(--orange); font-weight:800; font-size:0.7rem; letter-spacing:2px;" id="facility-type">PUBLIC FACILITY</div>
    <h2 class="facility-name" id="loo-name">â€”</h2>
    <p id="loo-address" style="color:var(--grey); font-size:0.85rem; margin-bottom:15px;"></p>
    <div id="loo-tags" style="display:flex; gap:8px; margin-bottom:20px;"></div>
    <button class="btn-go" onclick="openDirections()">â–¶ NAVIGATE</button>
    <button class="btn-secondary" onclick="openStreetView()">ğŸ‘ STREET VIEW</button>
</div>

<div id="post-run-summary" style="position: fixed; inset: 0; z-index: 4000; background: var(--navy); display: none; flex-direction: column; padding: calc(env(safe-area-inset-top, 0px) + 20px) 20px env(safe-area-inset-bottom, 20px); overflow-y: auto;">
    <div style="font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-style: italic; font-size: 2.5rem; color: var(--orange); margin-bottom: 5px;">RUN COMPLETE</div>
    <div id="post-run-date" style="color: var(--grey); font-size: 0.9rem; margin-bottom: 30px; text-transform: uppercase;"></div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div class="stat-card">
            <div class="stat-value" id="final-dist">0.00</div>
            <div class="stat-label">DISTANCE</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="final-pace" style="color: var(--orange);">--:--</div>
            <div class="stat-label">AVG PACE</div>
        </div>
    </div>

    <div class="stat-card" style="display: flex; align-items: center; justify-content: space-between; padding: 20px; margin-bottom: 20px;">
        <div style="text-align: left;">
            <div class="stat-label" style="margin: 0;">PIT STOPS NEARBY</div>
            <div class="stat-value" id="final-pits" style="color: var(--green); font-size: 2.5rem;">0</div>
        </div>
        <div style="font-size: 3rem;">ğŸ’©</div>
    </div>

    <button class="btn-go" onclick="shareRun()" style="background: var(--blue); box-shadow: 0 4px 0 #3367D6; margin-bottom: 12px;">ğŸ“¤ SHARE STATS</button>
    <button class="btn-go" onclick="closePostRun()">DONE</button>
</div>

<div id="overlay" onclick="closeAll()"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let map, markers = [], allLoos = [], currentLoo = null;
let blueDotMarker = null, isRunning = false, runWatchId = null;
let totalDistKm = 0, lastPos = null, runStartTime = null, runPath = [];
let directionsService, geocoder;

const UNITS = {
    distLong: 'KM',
    pace: 'MIN/KM',
    fromKm: km => km,
    fmtDist: (km) => km.toFixed(2) + ' km'
};

const DARK_MAP_STYLES = [
    { elementType: "geometry", stylers: [{ color: "#0D1628" }] },
    { featureType: "road", elementType: "geometry", stylers: [{ color: "#1A2740" }] },
    { featureType: "road.highway", elementType: "geometry.stroke", stylers: [{ color: "#FC4C02" }, { weight: 0.4 }] },
    { featureType: "water", elementType: "geometry", stylers: [{ color: "#06324F" }] },
    { featureType: "poi", stylers: [{ visibility: "off" }] },
    { featureType: "poi.park", stylers: [{ visibility: "on" }] },
    { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#0B2318" }] }
];

const POO_SVG_MARKER = {
    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="24">ğŸ’©</text></svg>'),
    scaledSize: new google.maps.Size(32, 32),
    anchor: new google.maps.Point(16, 16)
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -35.2809, lng: 149.1300 },
        zoom: 15,
        styles: DARK_MAP_STYLES,
        disableDefaultUI: true
    });

    directionsService = new google.maps.DirectionsService();
    geocoder = new google.maps.Geocoder();

    loadData();
    startBlueDot();
    map.addListener('idle', renderVisibleMarkers);
}

async function loadData() {
    try {
        const res = await fetch('toilets-au.json');
        allLoos = await res.json();
        renderVisibleMarkers();
    } catch(e) { console.error("Data load failed", e); }
}

function startBlueDot() {
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition(pos => {
        const latLng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        if (!blueDotMarker) {
            blueDotMarker = new google.maps.Marker({
                position: latLng, map,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: 'white', strokeWeight: 2 }
            });
            map.panTo(latLng);
        } else { blueDotMarker.setPosition(latLng); }
    }, null, { enableHighAccuracy: true });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORE LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVisibleMarkers() {
    const bounds = map.getBounds();
    markers.forEach(m => m.setMap(null));
    markers = allLoos
        .filter(l => bounds.contains({ lat: l.lat, lng: l.lon }))
        .slice(0, 50)
        .map(loo => {
            const m = new google.maps.Marker({ position: { lat: loo.lat, lng: loo.lon }, map, icon: POO_SVG_MARKER });
            m.addListener('click', () => openSheet(loo));
            return m;
        });
}

function openSheet(loo) {
    currentLoo = loo;
    document.getElementById('loo-name').innerText = loo.n;
    document.getElementById('loo-address').innerText = loo.a || 'No address provided';
    document.getElementById('sheet').classList.add('open');
    document.getElementById('overlay').classList.add('show');
}

function openDirections() {
    if (currentLoo) {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentLoo.lat},${currentLoo.lon}&travelmode=walking`, '_blank');
    }
}

function closeAll() {
    document.querySelectorAll('.open').forEach(el => el.classList.remove('open'));
    document.getElementById('overlay').classList.remove('show');
}

function navTap(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'run') toggleRun();
    if (tab === 'home') closeAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RUN TRACKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleRun() { isRunning ? stopRun() : startRun(); }

function startRun() {
    isRunning = true; totalDistKm = 0; runPath = []; runStartTime = Date.now();
    document.getElementById('run-hud').classList.add('active');
    document.getElementById('tab-run').classList.add('running');
    
    runWatchId = navigator.geolocation.watchPosition(pos => {
        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        if (accuracy > 30) return;
        
        if (lastPos) {
            const d = haversineKm(lastPos.lat, lastPos.lng, lat, lng);
            if (d > 0.005) { // 5 meter threshold
                totalDistKm += d;
                updateHUD(lat, lng);
            }
        }
        lastPos = { lat, lng };
    }, null, { enableHighAccuracy: true });
}

function stopRun() {
    isRunning = false;
    navigator.geolocation.clearWatch(runWatchId);
    document.getElementById('run-hud').classList.remove('active');
    document.getElementById('tab-run').classList.remove('running');
    
    // Show Summary
    const elapsed = (Date.now() - runStartTime) / 60000;
    document.getElementById('final-dist').innerText = totalDistKm.toFixed(2) + " KM";
    document.getElementById('final-pace').innerText = formatPace(totalDistKm > 0.1 ? elapsed / totalDistKm : 0);
    document.getElementById('final-pits').innerText = document.getElementById('hud-pits').innerText;
    document.getElementById('post-run-date').innerText = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'short', day: 'numeric' });
    document.getElementById('post-run-summary').style.display = 'flex';
}

function closePostRun() {
    document.getElementById('post-run-summary').style.display = 'none';
    navTap('home');
}

function shareRun() {
    const dist = document.getElementById('final-dist').innerText;
    const pace = document.getElementById('final-pace').innerText;
    const pits = document.getElementById('final-pits').innerText;
    const text = `I just finished a ${dist} run with ${pits} Pit Stops nearby! ğŸ’© Pace: ${pace} MIN/KM. Saved by HolyShit.app!`;

    if (navigator.share) {
        navigator.share({ title: 'HolyShit Run Summary', text: text, url: 'https://holyshit.app' });
    } else {
        navigator.clipboard.writeText(text);
        alert('Summary copied to clipboard!');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversineKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function formatPace(m) {
    if (!m || m === Infinity) return "--:--";
    const min = Math.floor(m), sec = Math.floor((m - min) * 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

function updateHUD(lat, lng) {
    document.getElementById('hud-dist').innerText = totalDistKm.toFixed(2);
    const elapsed = (Date.now() - runStartTime) / 60000;
    document.getElementById('hud-pace').innerText = formatPace(totalDistKm > 0.05 ? elapsed / totalDistKm : 0);
    
    // Count toilets within 500m for "Pit Stops"
    const nearby = allLoos.filter(l => haversineKm(lat, lng, l.lat, l.lon) < 0.5).length;
    document.getElementById('hud-pits').innerText = nearby;
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByuYcj_qjTbjC2sRWx8VmlMLMxELQ3fB8&libraries=geometry&callback=initMap" async defer></script>
</body>
</html>
