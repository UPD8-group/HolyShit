<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HolyShit.app ‚Äî Seek Sanctuary</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí©</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EAE6DF">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #EAE6DF; --card-bg: #FDF6E8; --border: #E2CEAD;
            --text: #2A1A0A; --gold: #B8841E; --red: #8B2635;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; background: var(--bg-color); overflow: hidden; }

        /* --- SPLASH PAGE --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: radial-gradient(circle at center, #FFFDF0 0%, #E2CEAD 100%);
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; box-sizing: border-box; transition: opacity 0.8s ease;
        }
        .divine-glow {
            position: absolute; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; z-index: 1; animation: pulse-glow 4s infinite alternate;
        }
        @keyframes pulse-glow {
            0% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); }
            100% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 150px rgba(255, 255, 255, 0.8), 0 0 200px rgba(255, 215, 0, 0.6); }
        }
        .majestic-poo { font-size: 7rem; z-index: 2; filter: drop-shadow(0 15px 15px rgba(0,0,0,0.2)); animation: float 3.5s ease-in-out infinite; margin-bottom: 10px; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        #splash h1 { font-family: 'Cinzel Decorative', cursive; font-size: 4.5rem; color: var(--red); margin: 0; text-shadow: 3px 3px var(--border); z-index: 2; position: relative; }
        #splash p { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--gold); margin: 15px 0 40px; font-weight: bold; letter-spacing: 1px; z-index: 2; position: relative; }
        .btn-enter { position: relative; z-index: 2; background: var(--red); color: white; border: none; padding: 20px 50px; border-radius: 40px; font-family: 'Cinzel', serif; font-size: 1.3rem; font-weight: bold; cursor: pointer; box-shadow: 0 6px 0 #601a25; transition: all 0.1s; }
        .btn-enter:active { transform: translateY(4px); box-shadow: 0 2px 0 #601a25; }
        .splash-footer { position: absolute; bottom: 20px; font-size: 0.8rem; color: #888; font-family: 'Nunito', sans-serif; z-index: 2; width: 100%; text-align: center; }

        /* --- BENTO LAYOUT --- */
        .bento-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; max-width: 1600px; margin: 0 auto; }
        .bento-card { background: var(--card-bg); border-radius: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); border: 1px solid var(--border); overflow: hidden; position: relative; }

        /* --- LEFT SIDEBAR (DASHBOARD) --- */
        .sidebar { padding: 30px; display: flex; flex-direction: column; overflow-y: auto; z-index: 2000; }
        
        /* Dashboard Header Area */
        .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        .logo-small { font-family: 'Cinzel Decorative', cursive; font-size: 2.2rem; color: var(--red); margin: 0; text-shadow: 1px 1px 0px var(--border); cursor: pointer; }
        .mobile-menu-toggle { display: none; font-size: 1.8rem; background: none; border: none; color: var(--gold); cursor: pointer; padding: 0; margin: 0; }

        #default-menu { display: flex; flex-direction: column; justify-content: center; height: 100%; transition: opacity 0.3s; }
        
        /* The Book of Relief Sermon */
        .sermon-text { font-size: 1.15rem; line-height: 1.8; color: var(--text); font-style: italic; background: rgba(226, 206, 173, 0.2); padding: 20px; border-radius: 15px; border-left: 4px solid var(--gold); }
        .sermon-title { font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.1rem; color: var(--gold); text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; font-style: normal; }

        /* The Giant Dashboard Panic Button */
        .btn-saviour { 
            background: var(--red); color: white; border: none; padding: 20px; border-radius: 15px; 
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.3rem; cursor: pointer; 
            width: 100%; margin-top: 30px; box-shadow: 0 6px 0 #601a25, 0 15px 20px rgba(139, 38, 53, 0.3); 
            transition: all 0.1s; animation: holy-pulse 2s infinite; display: flex; align-items: center; justify-content: center; gap: 10px; 
        }
        .btn-saviour:active { transform: translateY(6px); box-shadow: 0 0px 0 #601a25, 0 5px 10px rgba(139, 38, 53, 0.4); animation: none; }
        
        @keyframes holy-pulse {
            0% { box-shadow: 0 6px 0 #601a25, 0 0 0 0 rgba(139, 38, 53, 0.6); }
            70% { box-shadow: 0 6px 0 #601a25, 0 0 0 15px rgba(139, 38, 53, 0); }
            100% { box-shadow: 0 6px 0 #601a25, 0 0 0 0 rgba(139, 38, 53, 0); }
        }

        /* Loo Details View */
        #loo-details { display: none; }
        .tier-label { font-family: 'Cinzel', serif; font-weight: bold; font-size: 0.8rem; color: var(--gold); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1.5px;}
        .tags-container { display: flex; flex-wrap: wrap; gap: 5px; margin: 15px 0; }
        .tag { padding: 6px 10px; background: rgba(226, 206, 173, 0.3); border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; font-family: 'Cinzel', serif; display: flex; align-items: center; gap: 5px; }
        .scripture { font-style: italic; color: var(--gold); margin: 20px 0; border-left: 4px solid var(--gold); padding-left: 15px; font-size: 1rem; line-height: 1.5; }
        .btn-action { background: var(--red); color: white; border: none; padding: 16px; border-radius: 12px; font-family: 'Cinzel', serif; font-weight: bold; width: 100%; margin-top: 12px; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 0 #601a25; }
        .btn-back { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 10px; border-radius: 12px; cursor: pointer; margin-bottom: 20px; font-family: 'Nunito'; font-weight: bold; }
        .btn-report { background: transparent; color: #888; border: 1px dashed #ccc; padding: 10px; border-radius: 12px; width: 100%; margin-top: 20px; cursor: pointer; font-family: 'Nunito'; font-size: 0.9rem; }

        /* --- RIGHT SIDEBAR (MAP & CONTROLS) --- */
        #map { height: 100%; width: 100%; border-radius: 30px; }
        .map-ctrl { position: absolute; right: 20px; top: 90px; z-index: 100; }
        .ctrl-btn { background: white; border: 2px solid var(--border); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* --- REPORT MODAL --- */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 2px solid var(--border); text-align: center; }
        .modal-content h3 { font-family: 'Cinzel', serif; color: var(--red); margin-top: 0; }
        .modal-content select { width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 1px solid var(--border); font-family: 'Nunito'; font-size: 1rem; }
        .btn-submit { background: var(--red); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .btn-cancel { background: transparent; color: var(--text); border: none; margin-top: 10px; cursor: pointer; text-decoration: underline; }

        /* --- RESPONSIVE MOBILE LAYOUT --- */
        @media (max-width: 800px) {
            .bento-wrapper { display: block; padding: 0; height: 100vh; }
            #map { border-radius: 0; height: 100vh; }
            .map-ctrl { top: 90px; }
            #splash h1 { font-size: 3.5rem; }
            .majestic-poo { font-size: 5rem; }

            /* Dashboard converts to a floating top-bar */
            .sidebar { 
                position: absolute; top: 10px; left: 10px; right: 10px; 
                background: rgba(253, 246, 232, 0.95); backdrop-filter: blur(10px);
                max-height: 70px; padding: 15px 20px; border-radius: 20px; 
                transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.4s ease;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid var(--border);
            }
            
            .sidebar.menu-open { max-height: 70vh; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
            
            .header-row { margin-bottom: 0; border-bottom: none; padding-bottom: 0; transition: margin 0.3s; }
            .sidebar.menu-open .header-row { margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
            
            .mobile-menu-toggle { display: block; }

            /* Pull the Saviour button out of the dashboard and pin it to the bottom of the map */
            .btn-saviour {
                position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
                width: 85%; max-width: 350px; z-index: 2100; margin-top: 0;
                border-radius: 30px; font-size: 1.2rem;
            }
            .btn-saviour:active { transform: translateX(-50%) translateY(4px); }
        }
    </style>
</head>
<body>

    <form name="report-loo" data-netlify="true" hidden>
        <input type="text" name="loo_name">
        <input type="text" name="issue">
    </form>

    <div id="splash">
        <div class="divine-glow"></div>
        <div class="majestic-poo">üí©</div>
        <h1>HolyShit</h1>
        <p>Seek Sanctuary. Find Deliverance.</p>
        <button class="btn-enter" onclick="dismissSplash()">Enter the Gates</button>
        <div class="splash-footer">
            ¬© 2026 The Upd8 Group <br> Data provided by the National Public Toilet Map
        </div>
    </div>

    <div class="bento-wrapper">
        
        <div class="bento-card sidebar" id="app-sidebar">
            <div class="header-row">
                <h1 class="logo-small" onclick="resetSidebar()">HolyShit</h1>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            </div>
            
            <div id="default-menu">
                <div class="sermon-text">
                    <span class="sermon-title">The Book of Relief</span>
                    "Blessed are the desperate, for they shall find an open stall. We have mapped over 25,000 porcelain thrones across this great land. Fear no evil, just tap the button below and be delivered."
                </div>
                
                <button class="btn-saviour" id="btn-near-me" onclick="geolocate()">üïäÔ∏è Find Thee Saviour</button>
            </div>

            <div id="loo-details">
                <button class="btn-back" onclick="resetSidebar()">‚Üê Back</button>
                <span id="loo-tier" class="tier-label">House of Relief</span>
                <h2 id="loo-name" style="font-family: 'Cinzel', serif; margin: 0 0 5px 0; font-size: 1.6rem;">Sanctuary</h2>
                <p id="loo-address" style="color: #666; font-size: 0.95rem; margin: 0;"></p>
                <div id="loo-tags" class="tags-container"></div>
                <div class="scripture" id="loo-scripture"></div>
                
                <button class="btn-action" onclick="openDirections()">Navigate to Peace</button>
                <button class="btn-action" style="background: var(--gold); box-shadow: 0 4px 0 #8c6316;" onclick="openStreetView()">Behold the Entrance</button>
                
                <button class="btn-report" onclick="openReportModal()">‚ö†Ô∏è Report an Issue with this Sanctuary</button>
            </div>
        </div>

        <div class="bento-card">
            <div id="map"></div>
            <div class="map-ctrl">
                <button class="ctrl-btn" onclick="toggleMapType()" title="Satellite View">üõ∞Ô∏è</button>
            </div>
        </div>
    </div>

    <div id="report-modal">
        <div class="modal-content">
            <h3>Report Issue</h3>
            <p style="font-size: 0.9rem; color: #666;">Is there a false prophet among us? Let us know if this data is wrong.</p>
            <select id="report-reason">
                <option value="closed">Location is permanently closed</option>
                <option value="does_not_exist">Location doesn't exist here</option>
                <option value="wrong_details">Features/Tags are incorrect</option>
                <option value="unsafe">Location feels unsafe</option>
            </select>
            <button class="btn-submit" onclick="submitReport()">Submit to the Gatekeeper</button>
            <button class="btn-cancel" onclick="closeReportModal()">Cancel</button>
        </div>
    </div>

    <script>
        let map, currentLoo, markers = [], allLoos = [];

        function dismissSplash() {
            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; geolocate(); }, 800);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('app-sidebar');
            sidebar.classList.toggle('menu-open');
        }

        function resetSidebar() {
            document.getElementById('loo-details').style.display = 'none';
            document.getElementById('default-menu').style.display = 'flex';
            document.getElementById('app-sidebar').classList.add('menu-open'); // Auto-open menu when hitting back
        }

        async function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -35.2809, lng: 149.1300 }, 
                zoom: 14, disableDefaultUI: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });
            map.addListener("click", () => {
                document.getElementById('app-sidebar').classList.remove('menu-open'); // Auto-close menu on map click
            });
            map.addListener("idle", renderVisibleMarkers);
            loadData();
        }

        function geolocate() {
            const btn = document.getElementById("btn-near-me");
            btn.innerHTML = "‚è≥ Consulting heavens...";
            
            // Auto close mobile menu when seeking
            document.getElementById('app-sidebar').classList.remove('menu-open');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    map.panTo({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                    map.setZoom(15); btn.innerHTML = "üïäÔ∏è Find Thee Saviour"; renderVisibleMarkers();
                }, () => { btn.innerHTML = "üïäÔ∏è Find Thee Saviour"; alert("Enable location to find your nearest sanctuary."); });
            } else btn.innerHTML = "üïäÔ∏è Find Thee Saviour";
        }

        function toggleMapType() {
            map.setMapTypeId(map.getMapTypeId() === 'roadmap' ? 'satellite' : 'roadmap');
        }

        async function loadData() {
            try {
                const response = await fetch('toilets-au.json');
                allLoos = await response.json();
                renderVisibleMarkers();
            } catch (e) { console.error("Data load failed", e); }
        }

        function renderVisibleMarkers() {
            if (!map || !map.getBounds()) return;
            const bounds = map.getBounds();
            markers.forEach(m => m.setMap(null)); markers = [];

            let visible = allLoos.filter(loo => {
                return bounds.contains({lat: loo.lat, lng: loo.lon});
            });
            
            visible.slice(0, 80).forEach(loo => {
                const iconConfig = { url: `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text x="0" y="24" font-size="28">üí©</text></svg>`, anchor: new google.maps.Point(16, 24) };
                const marker = new google.maps.Marker({ position: { lat: loo.lat, lng: loo.lon }, map: map, icon: iconConfig });
                
                marker.addListener("click", () => {
                    populateSidebar(loo);
                    document.getElementById('app-sidebar').classList.add('menu-open'); // Auto-open details on mobile
                });
                markers.push(marker);
            });
        }

        function populateSidebar(loo) {
            currentLoo = loo;
            document.getElementById('default-menu').style.display = 'none';
            document.getElementById('loo-details').style.display = 'block';

            document.getElementById('loo-name').innerText = loo.n || "House of Relief";
            document.getElementById('loo-address').innerText = loo.a || "Location detailed on map";
            
            const tags = document.getElementById('loo-tags'); tags.innerHTML = '';
            if (loo.t) {
                if (loo.t.w) tags.innerHTML += '<span class="tag">‚ôø Accessible</span>';
                if (loo.t.b) tags.innerHTML += '<span class="tag">üçº Baby Change</span>';
                if (loo.t.u) tags.innerHTML += '<span class="tag">‚ößÔ∏è All Gender</span>';
                if (loo.t.f && !loo.t.u) tags.innerHTML += '<span class="tag">üö∫ Female</span>';
                if (loo.t.m && !loo.t.u) tags.innerHTML += '<span class="tag">üöπ Male</span>';
                if (loo.t.d) tags.innerHTML += '<span class="tag">üíß Water</span>';
                if (loo.t.o) tags.innerHTML += `<span class="tag" style="background: rgba(184, 132, 30, 0.2); border-color: var(--gold);">üïí ${loo.t.o}</span>`;
            }
            document.getElementById('loo-scripture').innerText = loo.note || "A humble, public sanctuary.";
        }

        function openDirections() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentLoo.lat},${currentLoo.lon}`); }
        function openStreetView() { window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentLoo.lat},${currentLoo.lon}`); }

        /* --- REPORTING LOGIC --- */
        function openReportModal() { document.getElementById('report-modal').style.display = 'flex'; }
        function closeReportModal() { document.getElementById('report-modal').style.display = 'none'; }
        
        function submitReport() {
            const reason = document.getElementById('report-reason').value;
            const looName = currentLoo.n || "Unknown Location";
            
            fetch("/", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    "form-name": "report-loo",
                    "loo_name": looName + " (Lat: " + currentLoo.lat + ", Lon: " + currentLoo.lon + ")",
                    "issue": reason
                }).toString()
            }).then(() => {
                alert("Thank you. The Gatekeeper has been notified and will review this location.");
                closeReportModal();
            }).catch((error) => {
                alert("Error sending report. Please try again.");
                closeReportModal();
            });
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{}));
        }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByuYcj_qjTbjC2sRWx8VmlMLMxELQ3fB8&callback=initMap" async defer></script>
</body>
</html>
