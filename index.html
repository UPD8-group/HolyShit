<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HolyShit ‚Äî Runner's Relief Radar</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöΩ</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F3F4F6">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,800;0,900;1,800;1,900&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #F3F4F6;       
            --card-bg: #FFFFFF;        
            --border: #E5E7EB;         
            --text-main: #111827;      
            --text-muted: #6B7280;     
            --primary: #FC4C02;        
            --primary-hover: #E34402;
            --secondary: #2563EB;      
            --water: #06B6D4;          
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: var(--bg-color); overflow: hidden; color: var(--text-main); }

        /* --- THE NEW ATHLETIC LOGO --- */
        .app-logo { 
            font-family: 'Montserrat', sans-serif; font-weight: 900; font-style: italic; 
            font-size: 2.2rem; margin: 0; text-transform: uppercase; letter-spacing: -2px; 
            color: var(--text-main); display: flex; align-items: center; justify-content: center;
        }
        .app-logo span.orange { color: var(--primary); letter-spacing: -1px; }
        .poo-emoji { font-style: normal; display: inline-block; font-size: 1.2em; margin: 0 -0.05em; transform: translateY(1px); }

        /* --- SPLASH PAGE --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: var(--text-main); 
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; box-sizing: border-box; transition: opacity 0.4s ease;
        }
        #splash .app-logo { font-size: 4.5rem; color: #FFFFFF; margin-bottom: 5px; }
        #splash .poo-emoji { transform: translateY(4px); }
        #splash p { font-family: 'Inter', sans-serif; font-size: 1.1rem; color: #9CA3AF; margin: 10px 0 40px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; }
        .btn-enter { background: var(--primary); color: white; border: none; padding: 18px 45px; border-radius: 12px; font-family: 'Montserrat', sans-serif; font-size: 1.2rem; font-weight: 800; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
        .btn-enter:active { transform: scale(0.96); background: var(--primary-hover); }

        /* --- BENTO LAYOUT --- */
        .bento-wrapper { display: grid; grid-template-columns: 380px 1fr; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; max-width: 1600px; margin: 0 auto; position: relative; }
        .bento-card { background: var(--card-bg); border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid var(--border); overflow: hidden; position: relative; }

        /* --- SIDEBAR --- */
        .sidebar { padding: 25px; display: flex; flex-direction: column; overflow-y: auto; z-index: 2000; box-sizing: border-box; }
        .mobile-peek { display: none; } 
        .header-row { margin-bottom: 25px; display: flex; align-items: center; justify-content: center; }

        #default-menu { display: flex; flex-direction: column; justify-content: flex-start; height: 100%; gap: 20px;}
        
        /* HUD */
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .hud-box { background: #F9FAFB; border: 1px solid var(--border); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
        .hud-box.full-width { grid-column: span 2; }
        .hud-label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
        .hud-value { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.6rem; color: var(--text-main); display: flex; align-items: baseline; gap: 4px;}
        .hud-unit { font-size: 0.9rem; font-weight: 700; color: var(--text-muted); }

        /* ACTION BUTTONS */
        .action-group { display: flex; flex-direction: column; gap: 12px; margin-top: auto; padding-top: 20px; width: 100%; box-sizing: border-box; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-sizing: border-box; }
        .btn-primary:active { transform: scale(0.98); background: var(--primary-hover); }
        .btn-secondary { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border); padding: 18px; border-radius: 12px; font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-sizing: border-box; }
        .btn-secondary:active { transform: scale(0.98); background: #E5E7EB; }

        /* Loo Details View */
        #loo-details { display: none; flex-direction: column; height: 100%; width: 100%; box-sizing: border-box;}
        .tier-label { font-family: 'Montserrat', sans-serif; font-weight: 800; font-size: 0.75rem; color: var(--secondary); text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 1px;}
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .tag { padding: 6px 12px; background: var(--bg-color); border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 5px; color: var(--text-main); }
        .tag-water { background: #ECFEFF; border-color: #67E8F9; color: #0E7490; } 
        
        .location-note { color: var(--text-muted); margin: 20px 0; font-size: 0.95rem; line-height: 1.5; font-weight: 600; }
        .btn-back { background: transparent; border: none; color: var(--text-muted); padding: 0; cursor: pointer; margin-bottom: 20px; font-family: 'Inter'; font-weight: 700; display: flex; align-items: center; gap: 5px; font-size: 0.9rem;}
        .btn-report { background: transparent; color: var(--text-muted); border: 1px dashed var(--border); padding: 12px; border-radius: 12px; width: 100%; margin-top: auto; cursor: pointer; font-weight: 600; font-size: 0.85rem; box-sizing: border-box;}

        /* --- RIGHT SIDEBAR (MAP) --- */
        #map { height: 100%; width: 100%; border-radius: 20px; }
        .map-ctrl { position: absolute; right: 20px; top: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: flex-end;}
        .ctrl-btn { background: white; border: 1px solid var(--border); width: 44px; height: 44px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .icon-crosshair { width: 20px; height: 20px; fill: var(--text-main); }
        .ctrl-btn:active { background: var(--bg-color); }

        #btn-install { display: none; background: var(--card-bg); border: 2px solid var(--primary); color: var(--primary); font-family: 'Montserrat', sans-serif; font-weight: 800; padding: 0 16px; height: 44px; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.08); align-items: center; gap: 8px; text-transform: uppercase; font-size: 0.85rem; }

        /* --- REPORT MODAL --- */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(17, 24, 39, 0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px);}
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); box-sizing: border-box;}
        .modal-content select { width: 100%; padding: 14px; margin: 15px 0; border-radius: 10px; border: 1px solid var(--border); font-family: 'Inter'; font-size: 1rem; font-weight: 600; outline: none; box-sizing: border-box;}

        /* --- RESPONSIVE MOBILE LAYOUT --- */
        @media (max-width: 800px) {
            .bento-wrapper { display: block; padding: 0; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; overflow: hidden; }
            .bento-card { border-radius: 0; border: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; overflow: visible; }
            #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
            
            #splash .app-logo { font-size: 3.5rem; }

            .map-ctrl { top: auto; bottom: 130px; right: 15px; z-index: 5000; }
            .header-row { display: none; }

            .sidebar { 
                position: fixed; bottom: 0; left: 0; right: 0; top: auto; z-index: 9999; height: auto;
                background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px);
                max-height: 85vh; padding: 10px 20px 30px; 
                border-radius: 24px 24px 0 0; border: 1px solid var(--border); border-bottom: none;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.08);
                transform: translateY(calc(100% - 90px));
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            .sidebar.menu-open { transform: translateY(0); }

            .mobile-peek { 
                display: flex; align-items: center; justify-content: center; 
                height: 40px; margin-bottom: 10px; cursor: pointer; position: relative;
            }
            .mobile-peek::before {
                content: ''; position: absolute; top: 5px; left: 50%; transform: translateX(-50%);
                width: 40px; height: 4px; background: #D1D5DB; border-radius: 4px;
            }
            
            .mobile-peek-title { 
                font-family: 'Montserrat', sans-serif; font-weight: 900; font-style: italic; 
                color: var(--text-main); font-size: 1.8rem; margin: 0; text-transform: uppercase; 
                letter-spacing: -2px; margin-top: 12px; display: flex; align-items: center; justify-content: center;
            }
            .mobile-peek-title span.orange { color: var(--primary); letter-spacing: -1px; }
            
            .hud-grid { margin-top: 10px; }
            .action-group { flex-direction: column; } /* Stack buttons vertically on mobile */
            .btn-primary, .btn-secondary { font-size: 1rem; padding: 16px; width: 100%; }
        }
    </style>
</head>
<body>

    <form name="report-loo" data-netlify="true" hidden>
        <input type="text" name="loo_name">
        <input type="text" name="issue">
    </form>

    <div id="splash">
        <h1 class="app-logo">H<span class="poo-emoji">üí©</span>LY<span class="orange">SHIT</span></h1>
        <p>Relief Radar Active</p>
        <button class="btn-enter" onclick="dismissSplash()">Launch</button>
    </div>

    <div class="bento-wrapper">
        <div class="bento-card">
            <div id="map"></div>
            <div class="map-ctrl">
                <button id="btn-install" onclick="installPWA()">üì≤ App</button>
                <button class="ctrl-btn" onclick="geolocate()" title="Locate Me">
                    <svg focusable="false" viewBox="0 0 24 24" class="icon-crosshair">
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path>
                    </svg>
                </button>
                <button class="ctrl-btn" onclick="toggleMapType()" title="Satellite View" style="font-size: 1.1rem;">üõ∞Ô∏è</button>
            </div>
        </div>

        <div class="bento-card sidebar" id="app-sidebar">
            <div class="mobile-peek" onclick="toggleMobileMenu()">
                <h1 class="mobile-peek-title">H<span class="poo-emoji">üí©</span>LY<span class="orange">SHIT</span></h1>
            </div>

            <div class="header-row">
                <h1 class="app-logo">H<span class="poo-emoji">üí©</span>LY<span class="orange">SHIT</span></h1>
            </div>
            
            <div id="default-menu">
                <div class="hud-grid">
                    <div class="hud-box">
                        <span class="hud-label">Distance</span>
                        <div class="hud-value" id="hud-distance">0.00 <span class="hud-unit">km</span></div>
                    </div>
                    <div class="hud-box">
                        <span class="hud-label">Pace</span>
                        <div class="hud-value" id="hud-pace">--:-- <span class="hud-unit">/km</span></div>
                    </div>
                    <div class="hud-box full-width">
                        <span class="hud-label">Pit Stops on Route</span>
                        <div class="hud-value" id="hud-stops">Ready to Track</div>
                    </div>
                </div>

                <div class="action-group">
                    <button class="btn-secondary" onclick="alert('Route Planning Coming Soon!')">üìç Plan</button>
                    <button class="btn-primary" id="btn-start-run" onclick="geolocate()">‚ñ∂ Start</button>
                </div>
            </div>

            <div id="loo-details">
                <button class="btn-back" onclick="resetSidebar()">‚Üê Back</button>
                <span id="loo-tier" class="tier-label">Facility Identified</span>
                <h2 id="loo-name" style="font-family: 'Montserrat', sans-serif; font-weight: 900; margin: 0 0 5px 0; font-size: 1.4rem;">Restroom</h2>
                <p id="loo-address" style="color: var(--text-muted); font-size: 0.95rem; margin: 0; font-weight: 600;"></p>
                <div id="loo-tags" class="tags-container"></div>
                <div class="location-note" id="loo-scripture"></div>
                
                <div class="action-group" style="padding-top: 0; margin-top: 0;">
                    <button class="btn-primary" onclick="openDirections()">Navigate</button>
                    <button class="btn-secondary" onclick="openStreetView()">Street View</button>
                </div>
                
                <button class="btn-report" onclick="openReportModal()">‚ö†Ô∏è Report an Issue</button>
            </div>
        </div>

    </div>

    <div id="report-modal">
        <div class="modal-content">
            <h3 style="font-family: 'Montserrat'; font-weight: 900; color: var(--text-main);">Report Issue</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted);">Keep the radar accurate.</p>
            <select id="report-reason">
                <option value="closed">Location is permanently closed</option>
                <option value="does_not_exist">Location doesn't exist here</option>
                <option value="wrong_details">Features/Tags are incorrect</option>
                <option value="unsafe">Location feels unsafe</option>
            </select>
            <button class="btn-primary" style="margin-top: 10px;" onclick="submitReport()">Submit Report</button>
            <button class="btn-back" style="width: 100%; justify-content: center; margin-top: 15px;" onclick="closeReportModal()">Cancel</button>
        </div>
    </div>

    <script>
        let map, currentLoo, markers = [], allLoos = [];
        let userMarker = null; 
        let deferredPrompt; 
        let directionsService, directionsRenderer; 

        function dismissSplash() {
            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; geolocate(); }, 400);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('app-sidebar');
            sidebar.classList.toggle('menu-open');
        }

        function resetSidebar() {
            document.getElementById('loo-details').style.display = 'none';
            document.getElementById('default-menu').style.display = 'flex';
            document.getElementById('app-sidebar').classList.add('menu-open'); 
            if (directionsRenderer) directionsRenderer.setDirections({routes: []}); 
        }

        async function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -35.2809, lng: 149.1300 }, 
                zoom: 14, disableDefaultUI: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true, 
                polylineOptions: { strokeColor: '#FC4C02', strokeWeight: 6, strokeOpacity: 0.8 } 
            });

            map.addListener("click", () => {
                document.getElementById('app-sidebar').classList.remove('menu-open'); 
            });
            map.addListener("idle", renderVisibleMarkers);
            loadData();
        }

        function geolocate() {
            const btn = document.getElementById("btn-start-run");
            if(btn) btn.innerHTML = "‚è≥ Locating...";
            
            document.getElementById('app-sidebar').classList.remove('menu-open');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.panTo(userLoc);
                    map.setZoom(16); 
                    
                    if (userMarker) userMarker.setMap(null);
                    userMarker = new google.maps.Marker({
                        position: userLoc, map: map, zIndex: 9999,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#2563EB', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 2 }
                    });

                    if(btn) btn.innerHTML = "‚ñ∂ Tracking"; 
                    renderVisibleMarkers();
                }, () => { 
                    if(btn) btn.innerHTML = "‚ñ∂ Start"; 
                    alert("Enable location to track your run."); 
                });
            } else { if(btn) btn.innerHTML = "‚ñ∂ Start"; }
        }

        function toggleMapType() {
            map.setMapTypeId(map.getMapTypeId() === 'roadmap' ? 'satellite' : 'roadmap');
        }

        async function loadData() {
            try {
                const response = await fetch('toilets-au.json');
                allLoos = await response.json();
                renderVisibleMarkers();
            } catch (e) { console.error("Data load failed", e); }
        }

        function renderVisibleMarkers() {
            if (!map || !map.getBounds()) return;
            const bounds = map.getBounds();
            markers.forEach(m => m.setMap(null)); markers = [];

            let visible = allLoos.filter(loo => { return bounds.contains({lat: loo.lat, lng: loo.lon}); });
            
            visible.slice(0, 80).forEach(loo => {
                const iconConfig = { url: `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text x="0" y="24" font-size="28">üí©</text></svg>`, anchor: new google.maps.Point(16, 24) };
                const marker = new google.maps.Marker({ position: { lat: loo.lat, lng: loo.lon }, map: map, icon: iconConfig });
                
                marker.addListener("click", () => {
                    populateSidebar(loo);
                    document.getElementById('app-sidebar').classList.add('menu-open'); 
                });
                markers.push(marker);
            });
        }

        function populateSidebar(loo) {
            currentLoo = loo;
            document.getElementById('default-menu').style.display = 'none';
            document.getElementById('loo-details').style.display = 'flex';

            document.getElementById('loo-name').innerText = loo.n || "Public Restroom";
            document.getElementById('loo-address').innerText = loo.a || "Location detailed on map";
            
            const tags = document.getElementById('loo-tags'); tags.innerHTML = '';
            
            if (loo.t) {
                if (loo.t.w) tags.innerHTML += '<span class="tag">‚ôø Accessible</span>';
                if (loo.t.d) tags.innerHTML += '<span class="tag tag-water">üíß Drinking Water</span>';
                if (loo.t.o) tags.innerHTML += `<span class="tag">üïí ${loo.t.o}</span>`;
            }
            document.getElementById('loo-scripture').innerText = loo.note || "";
        }

        function openDirections() { 
            if (!userMarker) {
                alert("Please hit 'Start' on the dashboard first so we can find your location!");
                return;
            }

            const origin = userMarker.getPosition();
            const destination = { lat: currentLoo.lat, lng: currentLoo.lon };

            directionsService.route({
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.WALKING 
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    document.getElementById('app-sidebar').classList.remove('menu-open');
                } else {
                    alert('Could not calculate a running route to this location.');
                }
            });
        }

        /* Brings back the Street View without the gyro glitch */
        function openStreetView() { 
            const panorama = map.getStreetView();
            panorama.setOptions({
                position: { lat: currentLoo.lat, lng: currentLoo.lon },
                motionTracking: false,
                motionTrackingControl: false
            });
            panorama.setVisible(true);
            document.getElementById('app-sidebar').classList.remove('menu-open');
        }

        /* --- PWA LOGIC --- */
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            document.getElementById('btn-install').style.display = 'flex';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') { document.getElementById('btn-install').style.display = 'none'; }
                    deferredPrompt = null;
                });
            } else { alert("To install on iPhone: Tap 'Share' in Safari, then 'Add to Home Screen'."); }
        }

        /* --- REPORTING LOGIC --- */
        function openReportModal() { document.getElementById('report-modal').style.display = 'flex'; }
        function closeReportModal() { document.getElementById('report-modal').style.display = 'none'; }
        function submitReport() {
            fetch("/", {
                method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ "form-name": "report-loo", "loo_name": (currentLoo.n || "Unknown") + " (Lat: " + currentLoo.lat + ")", "issue": document.getElementById('report-reason').value }).toString()
            }).then(() => { alert("Thank you. Report sent."); closeReportModal(); })
              .catch(() => { alert("Error sending report."); closeReportModal(); });
        }
        
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{})); }
    </script>
   
   
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByuYcj_qjTbjC2sRWx8VmlMLMxELQ3fB8&callback=initMap" async defer></script>
</body>
</html>
