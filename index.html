<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HolyShit.app ‚Äî Seek Sanctuary</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí©</text></svg>">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#EAE6DF">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #EAE6DF; --card-bg: #FDF6E8; --border: #E2CEAD;
            --text: #2A1A0A; --gold: #B8841E; --red: #8B2635;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Nunito', sans-serif; background: var(--bg-color); overflow: hidden; }

        /* --- SPLASH PAGE --- */
        #splash {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: radial-gradient(circle at center, #FFFDF0 0%, #E2CEAD 100%);
            z-index: 99999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px; box-sizing: border-box; transition: opacity 0.8s ease;
        }
        .divine-glow {
            position: absolute; width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%; z-index: 1; animation: pulse-glow 4s infinite alternate;
        }
        @keyframes pulse-glow {
            0% { transform: scale(1); opacity: 0.6; box-shadow: 0 0 50px rgba(255, 215, 0, 0.4); }
            100% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 150px rgba(255, 255, 255, 0.8), 0 0 200px rgba(255, 215, 0, 0.6); }
        }
        .majestic-poo { font-size: 7rem; z-index: 2; filter: drop-shadow(0 15px 15px rgba(0,0,0,0.2)); animation: float 3.5s ease-in-out infinite; margin-bottom: 10px; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        #splash h1 { font-family: 'Cinzel Decorative', cursive; font-size: 4.5rem; color: var(--red); margin: 0; text-shadow: 3px 3px var(--border); z-index: 2; position: relative; }
        #splash p { font-family: 'Cinzel', serif; font-size: 1.2rem; color: var(--gold); margin: 15px 0 40px; font-weight: bold; letter-spacing: 1px; z-index: 2; position: relative; }
        .btn-enter { position: relative; z-index: 2; background: var(--red); color: white; border: none; padding: 20px 50px; border-radius: 40px; font-family: 'Cinzel', serif; font-size: 1.3rem; font-weight: bold; cursor: pointer; box-shadow: 0 6px 0 #601a25; transition: all 0.1s; }
        .btn-enter:active { transform: translateY(4px); box-shadow: 0 2px 0 #601a25; }
        .splash-footer { position: absolute; bottom: 20px; font-size: 0.8rem; color: #888; font-family: 'Nunito', sans-serif; z-index: 2; width: 100%; text-align: center; }

        /* --- BENTO LAYOUT (Desktop) --- */
        .bento-wrapper { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; max-width: 1600px; margin: 0 auto; position: relative; }
        .bento-card { background: var(--card-bg); border-radius: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); border: 1px solid var(--border); overflow: hidden; position: relative; }

        /* --- SIDEBAR (DASHBOARD) --- */
        .sidebar { padding: 30px; display: flex; flex-direction: column; overflow-y: auto; z-index: 2000; }
        
        .mobile-peek { display: none; } 
        .header-row { margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        .logo-small { font-family: 'Cinzel Decorative', cursive; font-size: 2.2rem; color: var(--red); margin: 0; text-shadow: 1px 1px 0px var(--border); cursor: pointer; }

        #default-menu { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        
        .sermon-text { font-size: 1.15rem; line-height: 1.8; color: var(--text); font-style: italic; background: rgba(226, 206, 173, 0.2); padding: 20px; border-radius: 15px; border-left: 4px solid var(--gold); }
        .sermon-title { font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.1rem; color: var(--gold); text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; font-style: normal; }

        .btn-saviour { 
            background: var(--red); color: white; border: none; padding: 18px; border-radius: 15px; 
            font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.2rem; cursor: pointer; 
            width: 100%; margin-top: 25px; box-shadow: 0 5px 0 #601a25; 
            transition: all 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px; 
        }
        .btn-saviour:active { transform: translateY(4px); box-shadow: 0 1px 0 #601a25; }

        /* Loo Details View */
        #loo-details { display: none; }
        .tier-label { font-family: 'Cinzel', serif; font-weight: bold; font-size: 0.8rem; color: var(--gold); text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1.5px;}
        .tags-container { display: flex; flex-wrap: wrap; gap: 5px; margin: 15px 0; }
        .tag { padding: 6px 10px; background: rgba(226, 206, 173, 0.3); border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; font-family: 'Cinzel', serif; display: flex; align-items: center; gap: 5px; }
        .scripture { font-style: italic; color: var(--gold); margin: 20px 0; border-left: 4px solid var(--gold); padding-left: 15px; font-size: 1rem; line-height: 1.5; }
        .btn-action { background: var(--red); color: white; border: none; padding: 16px; border-radius: 12px; font-family: 'Cinzel', serif; font-weight: bold; width: 100%; margin-top: 12px; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 0 #601a25; }
        .btn-back { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 10px; border-radius: 12px; cursor: pointer; margin-bottom: 20px; font-family: 'Nunito'; font-weight: bold; }
        .btn-report { background: transparent; color: #888; border: 1px dashed #ccc; padding: 10px; border-radius: 12px; width: 100%; margin-top: 20px; cursor: pointer; font-family: 'Nunito'; font-size: 0.9rem; }

        /* --- RIGHT SIDEBAR (MAP & CONTROLS) --- */
        #map { height: 100%; width: 100%; border-radius: 30px; }
        .map-ctrl { position: absolute; right: 20px; top: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; align-items: flex-end;}
        .ctrl-btn { background: white; border: 2px solid var(--border); width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .icon-crosshair { width: 22px; height: 22px; fill: #666; }
        .ctrl-btn:active .icon-crosshair { fill: #4285F4; }

        /* PWA Install Button */
        #btn-install { display: none; background: var(--card-bg); border: 2px solid var(--gold); color: var(--text); font-family: 'Nunito', sans-serif; font-weight: bold; padding: 0 15px; height: 45px; border-radius: 25px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); align-items: center; gap: 8px; white-space: nowrap; }

        /* --- REPORT MODAL --- */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 2px solid var(--border); text-align: center; }
        .modal-content h3 { font-family: 'Cinzel', serif; color: var(--red); margin-top: 0; }
        .modal-content select { width: 100%; padding: 12px; margin: 15px 0; border-radius: 10px; border: 1px solid var(--border); font-family: 'Nunito'; font-size: 1rem; }
        .btn-submit { background: var(--red); color: white; border: none; padding: 12px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .btn-cancel { background: transparent; color: var(--text); border: none; margin-top: 10px; cursor: pointer; text-decoration: underline; }

        /* --- RESPONSIVE MOBILE LAYOUT (The Bottom Sheet) --- */
        @media (max-width: 800px) {
            .bento-wrapper { display: block; padding: 0; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; overflow: hidden; }
            
            /* Give the map card explicit full dimensions so the map doesn't get squished */
            .bento-card { border-radius: 0; border: none; position: absolute; width: 100%; height: 100%; top: 0; left: 0; overflow: visible; }
            
            #map { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 1; }
            #splash h1 { font-size: 3.5rem; }
            .majestic-poo { font-size: 5rem; }

            /* Map controls move to bottom right, above the sheet */
            .map-ctrl { top: auto; bottom: 100px; right: 15px; z-index: 5000; }

            .header-row { display: none; }

            /* Fixed Bottom Sheet - Needs explicit height: auto to override the 100% height from bento-card */
            .sidebar { 
                position: fixed; bottom: 0; left: 0; right: 0; top: auto; z-index: 9999; height: auto;
                background: rgba(253, 246, 232, 0.98); backdrop-filter: blur(15px);
                max-height: 85vh; padding: 15px 20px 30px; 
                border-radius: 25px 25px 0 0; border: 1px solid var(--border); border-bottom: none;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
                transform: translateY(calc(100% - 75px)); /* 75px peeks out */
                transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            }
            
            .sidebar.menu-open { transform: translateY(0); }

            .mobile-peek { 
                display: flex; align-items: center; justify-content: center; 
                height: 40px; margin-bottom: 5px; cursor: pointer; position: relative;
            }
            .mobile-peek::before {
                content: ''; position: absolute; top: -5px; left: 50%; transform: translateX(-50%);
                width: 45px; height: 5px; background: #D1BFA4; border-radius: 5px;
            }
            .mobile-peek-title { font-family: 'Cinzel Decorative', cursive; color: var(--red); font-size: 1.5rem; margin: 0; }
            .mobile-peek-icon { position: absolute; right: 0; font-size: 1.4rem; color: var(--gold); }
        }
    </style>
</head>
<body>

    <form name="report-loo" data-netlify="true" hidden>
        <input type="text" name="loo_name">
        <input type="text" name="issue">
    </form>

    <div id="splash">
        <div class="divine-glow"></div>
        <div class="majestic-poo">üí©</div>
        <h1>HolyShit</h1>
        <p>Seek Sanctuary. Find Deliverance.</p>
        <button class="btn-enter" onclick="dismissSplash()">Enter the Gates</button>
        <div class="splash-footer">
            ¬© 2026 The Upd8 Group <br> Data provided by the National Public Toilet Map
        </div>
    </div>

    <div class="bento-wrapper">
        
        <div class="bento-card">
            <div id="map"></div>
            <div class="map-ctrl">
                <button id="btn-install" onclick="installPWA()">üì≤ Install App</button>

                <button class="ctrl-btn" onclick="geolocate()" title="Locate Me">
                    <svg focusable="false" viewBox="0 0 24 24" class="icon-crosshair">
                        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path>
                    </svg>
                </button>
                <button class="ctrl-btn" onclick="toggleMapType()" title="Satellite View" style="font-size: 1.1rem;">üõ∞Ô∏è</button>
            </div>
        </div>

        <div class="bento-card sidebar" id="app-sidebar">
            <div class="mobile-peek" onclick="toggleMobileMenu()">
                <h1 class="mobile-peek-title">HolyShit</h1>
                <span class="mobile-peek-icon">‚ò∞</span>
            </div>

            <div class="header-row">
                <h1 class="logo-small" onclick="resetSidebar()">HolyShit</h1>
            </div>
            
            <div id="default-menu">
                <div class="sermon-text">
                    <span class="sermon-title">The Book of Relief</span>
                    "Blessed are the desperate, for they shall find an open stall. We have mapped over 25,000 porcelain thrones across this great land. Fear no evil, just tap the button below and be delivered."
                </div>
                <button class="btn-saviour" id="btn-saviour-menu" onclick="geolocate()">üïäÔ∏è Find Thee Saviour</button>
            </div>

            <div id="loo-details">
                <button class="btn-back" onclick="resetSidebar()">‚Üê Back</button>
                <span id="loo-tier" class="tier-label">House of Relief</span>
                <h2 id="loo-name" style="font-family: 'Cinzel', serif; margin: 0 0 5px 0; font-size: 1.6rem;">Sanctuary</h2>
                <p id="loo-address" style="color: #666; font-size: 0.95rem; margin: 0;"></p>
                <div id="loo-tags" class="tags-container"></div>
                <div class="scripture" id="loo-scripture"></div>
                <button class="btn-action" onclick="openDirections()">Navigate to Peace</button>
                <button class="btn-action" style="background: var(--gold); box-shadow: 0 4px 0 #8c6316;" onclick="openStreetView()">Behold the Entrance</button>
                <button class="btn-report" onclick="openReportModal()">‚ö†Ô∏è Report an Issue with this Sanctuary</button>
            </div>
        </div>

    </div>

    <div id="report-modal">
        <div class="modal-content">
            <h3>Report Issue</h3>
            <p style="font-size: 0.9rem; color: #666;">Is there a false prophet among us? Let us know if this data is wrong.</p>
            <select id="report-reason">
                <option value="closed">Location is permanently closed</option>
                <option value="does_not_exist">Location doesn't exist here</option>
                <option value="wrong_details">Features/Tags are incorrect</option>
                <option value="unsafe">Location feels unsafe</option>
            </select>
            <button class="btn-submit" onclick="submitReport()">Submit to the Gatekeeper</button>
            <button class="btn-cancel" onclick="closeReportModal()">Cancel</button>
        </div>
    </div>

    <script>
        let map, currentLoo, markers = [], allLoos = [];
        let userMarker = null; 
        let deferredPrompt; 

        function dismissSplash() {
            const splash = document.getElementById('splash');
            splash.style.opacity = '0';
            setTimeout(() => { splash.style.display = 'none'; geolocate(); }, 800);
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('app-sidebar');
            sidebar.classList.toggle('menu-open');
        }

        function resetSidebar() {
            document.getElementById('loo-details').style.display = 'none';
            document.getElementById('default-menu').style.display = 'flex';
            document.getElementById('app-sidebar').classList.add('menu-open'); 
        }

        async function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -35.2809, lng: 149.1300 }, 
                zoom: 14, disableDefaultUI: true,
                styles: [{ featureType: "poi.business", stylers: [{ visibility: "off" }] }]
            });
            map.addListener("click", () => {
                document.getElementById('app-sidebar').classList.remove('menu-open'); 
            });
            map.addListener("idle", renderVisibleMarkers);
            loadData();
        }

        function geolocate() {
            const btn = document.getElementById("btn-saviour-menu");
            if(btn) btn.innerHTML = "‚è≥ Consulting heavens...";
            
            document.getElementById('app-sidebar').classList.remove('menu-open');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.panTo(userLoc);
                    map.setZoom(15); 
                    
                    if (userMarker) userMarker.setMap(null);
                    userMarker = new google.maps.Marker({
                        position: userLoc, map: map, zIndex: 9999,
                        icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: '#ffffff', strokeWeight: 2 }
                    });

                    if(btn) btn.innerHTML = "üïäÔ∏è Find Thee Saviour"; 
                    renderVisibleMarkers();
                }, () => { 
                    if(btn) btn.innerHTML = "üïäÔ∏è Find Thee Saviour"; 
                    alert("Enable location to find your nearest sanctuary."); 
                });
            } else { if(btn) btn.innerHTML = "üïäÔ∏è Find Thee Saviour"; }
        }

        function toggleMapType() {
            map.setMapTypeId(map.getMapTypeId() === 'roadmap' ? 'satellite' : 'roadmap');
        }

        async function loadData() {
            try {
                const response = await fetch('toilets-au.json');
                allLoos = await response.json();
                renderVisibleMarkers();
            } catch (e) { console.error("Data load failed", e); }
        }

        function renderVisibleMarkers() {
            if (!map || !map.getBounds()) return;
            const bounds = map.getBounds();
            markers.forEach(m => m.setMap(null)); markers = [];

            let visible = allLoos.filter(loo => { return bounds.contains({lat: loo.lat, lng: loo.lon}); });
            
            visible.slice(0, 80).forEach(loo => {
                const iconConfig = { url: `data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text x="0" y="24" font-size="28">üí©</text></svg>`, anchor: new google.maps.Point(16, 24) };
                const marker = new google.maps.Marker({ position: { lat: loo.lat, lng: loo.lon }, map: map, icon: iconConfig });
                
                marker.addListener("click", () => {
                    populateSidebar(loo);
                    document.getElementById('app-sidebar').classList.add('menu-open'); 
                });
                markers.push(marker);
            });
        }

        function populateSidebar(loo) {
            currentLoo = loo;
            document.getElementById('default-menu').style.display = 'none';
            document.getElementById('loo-details').style.display = 'block';

            document.getElementById('loo-name').innerText = loo.n || "House of Relief";
            document.getElementById('loo-address').innerText = loo.a || "Location detailed on map";
            
            const tags = document.getElementById('loo-tags'); tags.innerHTML = '';
            if (loo.t) {
                if (loo.t.w) tags.innerHTML += '<span class="tag">‚ôø Accessible</span>';
                if (loo.t.b) tags.innerHTML += '<span class="tag">üçº Baby Change</span>';
                if (loo.t.u) tags.innerHTML += '<span class="tag">‚ößÔ∏è All Gender</span>';
                if (loo.t.f && !loo.t.u) tags.innerHTML += '<span class="tag">üö∫ Female</span>';
                if (loo.t.m && !loo.t.u) tags.innerHTML += '<span class="tag">üöπ Male</span>';
                if (loo.t.d) tags.innerHTML += '<span class="tag">üíß Water</span>';
                if (loo.t.o) tags.innerHTML += `<span class="tag" style="background: rgba(184, 132, 30, 0.2); border-color: var(--gold);">üïí ${loo.t.o}</span>`;
            }
            document.getElementById('loo-scripture').innerText = loo.note || "A humble, public sanctuary.";
        }

        function openDirections() { window.open(`https://www.google.com/maps/dir/?api=1&destination=${currentLoo.lat},${currentLoo.lon}`); }
        function openStreetView() { window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentLoo.lat},${currentLoo.lon}`); }

        /* --- PWA INSTALLATION LOGIC --- */
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('btn-install').style.display = 'flex';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('btn-install').style.display = 'none';
                    }
                    deferredPrompt = null;
                });
            } else {
                alert("To install on iPhone: Tap the 'Share' button at the bottom of Safari, then tap 'Add to Home Screen'.");
            }
        }

        /* --- REPORTING LOGIC --- */
        function openReportModal() { document.getElementById('report-modal').style.display = 'flex'; }
        function closeReportModal() { document.getElementById('report-modal').style.display = 'none'; }
        function submitReport() {
            fetch("/", {
                method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ "form-name": "report-loo", "loo_name": (currentLoo.n || "Unknown") + " (Lat: " + currentLoo.lat + ")", "issue": document.getElementById('report-reason').value }).toString()
            }).then(() => { alert("Thank you. The Gatekeeper has been notified."); closeReportModal(); })
              .catch(() => { alert("Error sending report."); closeReportModal(); });
        }
        
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('sw.js').catch(()=>{})); }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyByuYcj_qjTbjC2sRWx8VmlMLMxELQ3fB8&callback=initMap" async defer></script>
</body>
</html>
